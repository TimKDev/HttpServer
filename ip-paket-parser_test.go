package main

import (
	"testing"
)

func TestParseIPPaketV4(t *testing.T) {
	t.Run("cannot parse IPv6 package", func(t *testing.T) {
		ipV6Package := []byte{0x60, 0x6, 0xca, 0xef, 0x0, 0x20, 0x6, 0x3c, 0x2a, 0x2, 0x26, 0xf0, 0xab, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0xb8, 0x19, 0x32, 0xc8, 0x20, 0x1, 0x9, 0xe8, 0x53, 0xdf, 0x2, 0x0, 0x80, 0x13, 0xe7, 0x97, 0x29, 0x94, 0xd9, 0x24, 0x1, 0xbb, 0xa2, 0x8e, 0x14, 0x9d, 0xa0, 0xdb, 0x6d, 0xdf, 0x7f, 0x5c, 0x80, 0x11, 0x1, 0xf5, 0x26, 0x44, 0x0, 0x0, 0x1, 0x1, 0x8, 0xa, 0xb2, 0x0, 0x47, 0x63, 0x6c, 0x73, 0xd0, 0xac}
		_, err := ParseIPPaketV4(ipV6Package)
		AssertError(t, "unsupported IP version: 6", err)
	})

	t.Run("parse valid IPv4 package", func(t *testing.T) {
		iPv4Package := []byte{0x45, 0x0, 0x0, 0x34, 0xfe, 0xbf, 0x40, 0x0, 0x40, 0x6, 0x3f, 0xfb, 0xc0, 0xa8, 0xb2, 0x33, 0x12, 0xeb, 0x76, 0x42, 0x9e, 0x92, 0x1, 0xbb, 0xce, 0x84, 0x2e, 0xe6, 0xe1, 0x4b, 0x72, 0x2f, 0x80, 0x10, 0x1, 0xe2, 0xfc, 0x2f, 0x0, 0x0, 0x1, 0x1, 0x8, 0xa, 0x96, 0x4e, 0x5a, 0xf9, 0x1c, 0x3c, 0xa1, 0xf1}

		_, err := ParseIPPaketV4(iPv4Package)
		AssertNoError(t, err)
	})

	t.Run("check for invalid ip flag", func(t *testing.T) {
		iPv4Package := []byte{0x45, 0x0, 0x0, 0x34, 0xfe, 0xbf, 0x44, 0x0, 0x40, 0x6, 0x3f, 0xfb, 0xc0, 0xa8, 0xb2, 0x33, 0x12, 0xeb, 0x76, 0x42, 0x9e, 0x92, 0x1, 0xbb, 0xce, 0x84, 0x2e, 0xe6, 0xe1, 0x4b, 0x72, 0x2f, 0x80, 0x10, 0x1, 0xe2, 0xfc, 0x2f, 0x0, 0x0, 0x1, 0x1, 0x8, 0xa, 0x96, 0x4e, 0x5a, 0xf9, 0x1c, 0x3c, 0xa1, 0xf1}

		_, err := ParseIPPaketV4(iPv4Package)
		AssertError(t, "invalid ip package: first Bit of IP Flags is not zero", err)
	})
}

func AssertError(t *testing.T, expectedErrorMessage string, err error) {
	if err == nil {
		t.Errorf("Expected Error Message: %s\n", expectedErrorMessage)
		t.Error("Actual Error Message: nil")
		return
	}
	if err.Error() != expectedErrorMessage {
		t.Errorf("Expected Error Message: %s\n", expectedErrorMessage)
		t.Errorf("Actual Error Message: %s", err.Error())
	}
}

func AssertNoError(t *testing.T, err error) {
	if err != nil {
		t.Errorf("Expected success but got error: %s", err.Error())
	}
}
